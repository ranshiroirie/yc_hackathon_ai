---
description: モノレポコンポーネント間調整・連携ルール
globs:
  - "**/*.dart"
  - "**/*.ts"
  - "**/*.js"
  - "**/*.md"
alwaysApply: auto
---

# モノレポ コンポーネント間調整ルール

## 🔄 コンポーネント構成と責任

### アーキテクチャ階層
```
Flutter App (flutter-app/)     ← ユーザーインターフェース
    ↓ API呼び出し
Firebase Functions (firebase/) ← ビジネスロジック・データアクセス
    ↓ データ操作
Airtable + Supabase           ← データストレージ
    ↓ 設計根拠
System Documentation (system-doc/) ← 要求仕様・方式設計
```

### 各コンポーネントの役割
- **Flutter App**: UI・UX・クライアント側状態管理・認証フロー
- **Firebase Functions**: API・ビジネスロジック・データ変換・外部API統合
- **Supabase**: 追加データベース・リアルタイム機能・認証拡張
- **System Documentation**: 要求仕様・方式設計・PlantUML図・品質基準

## 📡 コンポーネント間通信ルール

### API契約管理
- **Firebase Functions**: Callable Functions でセキュアなAPI提供
- **型定義共有**: インターフェース定義の一貫性維持
- **エラーハンドリング**: 統一されたエラーレスポンス形式
- **バージョニング**: API変更時の後方互換性確保

### データフォーマット統一
- **日付**: ISO 8601形式（`YYYY-MM-DDTHH:mm:ss.sssZ`）
- **ユーザーID**: Firebase Auth UID使用（AirtableレコードID露出禁止）
- **null値処理**: `blank_param`配列での明示的null表現
- **多言語対応**: `_jp`、`_en`サフィックスでの言語別データ

## 🔧 開発フロー調整

### 機能開発手順
1. **設計書更新**: system-doc/で要求仕様・方式設計追記
2. **API設計**: Firebase Functionsでインターフェース定義
3. **バックエンド実装**: Functions・Supabase側実装
4. **フロントエンド実装**: Flutter App側実装
5. **統合テスト**: コンポーネント間連携確認
6. **ドキュメント同期**: 実装と設計書の整合性確認

### コード生成要件
- **Flutter**: モデル・プロバイダー・ルート変更後は必ずコード生成
- **Firebase**: TypeScriptビルド必須
- **依存関係**: 変更影響範囲の事前確認・調整

### 環境管理
- **開発**: Firebase Emulators + ローカルSupabase
- **ステージング**: 統合テスト環境
- **本番**: 本番Firebase + 本番Supabase

## 📋 品質保証調整

### クロスコンポーネントテスト
- **API統合テスト**: Flutter ↔ Firebase Functions
- **データ整合性**: Firebase Functions ↔ Airtable/Supabase
- **認証フロー**: 全コンポーネント間での認証状態同期
- **エラーハンドリング**: 各層でのエラー伝播・処理確認

### パフォーマンス調整
- **キャッシュ戦略**: Functions側キャッシュとApp側キャッシュの調整
- **データ転送量**: 必要最小限のデータ送信設計
- **応答時間**: コンポーネント間通信の最適化

## 🚨 変更影響管理

### 破壊的変更の事前確認
- **API変更**: Functionsの既存エンドポイント変更時
- **データモデル変更**: Airtable/Supabaseスキーマ変更時  
- **認証フロー変更**: Firebase Auth設定変更時
- **環境設定変更**: 各種API Key・設定値変更時

### 段階的移行パターン
- **APIバージョニング**: V1維持しながらV2導入
- **機能フラグ**: 新機能の段階的展開
- **データ移行**: 既存データを破壊せず新スキーマ移行
- **後方互換性**: 既存クライアント動作保証

## 💰 コスト最適化調整

### 全体コスト管理
- **Firebase Functions**: 月¥5,000以下維持（70-80%削減達成済み）
- **Supabase**: 使用量監視・最適化
- **Airtable**: API呼び出し回数最小化
- **外部API**: Google Maps等の使用量最適化

### 監視・アラート
- **コストメトリクス**: 定期的な使用量・コスト確認
- **パフォーマンス**: レスポンス時間・エラー率監視
- **異常検知**: 予期しない使用量増加の早期発見

## 📖 ドキュメント同期ルール

### 設計書との整合性
- **要求仕様**: 機能実装前の仕様確認必須
- **方式設計**: 技術実装の設計書準拠確認
- **API仕様**: インターフェース定義の同期維持
- **PlantUML図**: シーケンス図・ER図の実装反映

### 変更時の更新手順
1. **実装変更**: コード変更実施
2. **影響分析**: 他コンポーネントへの影響確認
3. **ドキュメント更新**: 設計書・仕様書への反映
4. **チーム共有**: 変更内容・影響範囲の周知

---

**重要**: コンポーネント間の調整は複雑です。不明な点や影響範囲が不明な場合は、必ず質問・確認してください。