# Supabase DBã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ ãƒ­ãƒ¼ãƒ«å®šç¾©

## ğŸ—„ï¸ å½¹å‰²ã¨è²¬ä»»

### åŸºæœ¬æƒ…å ±
- **å½¹å‰²å**: Supabase DBã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- **æ‹…å½“AI**: Claude Code AI (MCPçµŒç”±)
- **ãƒ¬ãƒãƒ¼ãƒˆå…ˆ**: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ
- **å”åƒç›¸æ‰‹**: Flutter/Firebaseã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢

### ä¸»è¦è²¬ä»»
1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ**: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆãƒ»ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–
2. **RPC/é–¢æ•°é–‹ç™º**: PostgreSQLé–¢æ•°ãƒ»ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£å®Ÿè£…
3. **RLSå®Ÿè£…**: Row Level Securityãƒãƒªã‚·ãƒ¼è¨­è¨ˆãƒ»å®Ÿè£…
4. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½**: Realtimeè³¼èª­ãƒ»ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆè¨­è¨ˆ
5. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãƒ»ãƒ‡ãƒ¼ã‚¿ç§»è¡Œç®¡ç†

## ğŸ”§ é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹

### 1. è¦ä»¶åˆ†æãƒ•ã‚§ãƒ¼ã‚º
```markdown
## DBè¦ä»¶ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¦ä»¶ã®ç†è§£
- [ ] ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®ç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã®æŠŠæ¡
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¦ä»¶ã®æœ‰ç„¡
```

### 2. è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚º
```markdown
## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ‰‹é †

1. **è«–ç†è¨­è¨ˆ**
   - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©
   - ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ
   - æ­£è¦åŒ–ãƒ¬ãƒ™ãƒ«æ±ºå®š

2. **ç‰©ç†è¨­è¨ˆ**
   - ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
   - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æˆ¦ç•¥

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ**
   - RLSãƒãƒªã‚·ãƒ¼å®šç¾©
   - ãƒ­ãƒ¼ãƒ«ãƒ»æ¨©é™è¨­è¨ˆ
   - ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–æ–¹é‡

4. **é–¢æ•°è¨­è¨ˆ**
   - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°
   - ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°
   - é›†è¨ˆãƒ»åˆ†æé–¢æ•°

5. **æœ€é©åŒ–è¨­è¨ˆ**
   - ã‚¯ã‚¨ãƒªæœ€é©åŒ–
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
```

### 3. å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚º
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- RPCé–¢æ•°å®Ÿè£…
- RLSãƒãƒªã‚·ãƒ¼å®Ÿè£…
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

## ğŸ“Š å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### é«˜æ€§èƒ½æ¤œç´¢é–¢æ•°
```sql
-- âœ… ä½ç½®æƒ…å ±æ¤œç´¢ã®æœ€é©åŒ–ä¾‹
CREATE OR REPLACE FUNCTION search_nearby_locations(
  user_lat DOUBLE PRECISION,
  user_lng DOUBLE PRECISION,
  radius_km INTEGER DEFAULT 5,
  category_filter TEXT[] DEFAULT NULL,
  limit_count INTEGER DEFAULT 50
)
RETURNS TABLE (
  id UUID,
  name TEXT,
  distance_km NUMERIC,
  category TEXT,
  rating NUMERIC,
  matched_filters JSONB
)
LANGUAGE plpgsql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  RETURN QUERY
  WITH filtered_locations AS (
    SELECT 
      l.*,
      earth_distance(
        ll_to_earth(user_lat, user_lng),
        ll_to_earth(l.latitude, l.longitude)
      ) / 1000.0 AS distance_km
    FROM locations l
    WHERE 
      -- ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨
      earth_box(ll_to_earth(user_lat, user_lng), radius_km * 1000) 
      @> ll_to_earth(l.latitude, l.longitude)
      -- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      AND (category_filter IS NULL OR l.category = ANY(category_filter))
      -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿
      AND l.is_active = TRUE
  )
  SELECT 
    fl.id,
    fl.name,
    fl.distance_km,
    fl.category,
    fl.rating,
    jsonb_build_object(
      'distance', fl.distance_km < 1,
      'high_rating', fl.rating >= 4.5,
      'category_match', category_filter IS NOT NULL
    ) AS matched_filters
  FROM filtered_locations fl
  WHERE fl.distance_km <= radius_km
  ORDER BY 
    fl.distance_km ASC,
    fl.rating DESC NULLS LAST
  LIMIT limit_count;
END;
$$;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_locations_spatial 
ON locations USING GIST(ll_to_earth(latitude, longitude))
WHERE is_active = TRUE;
```

### RLSãƒãƒªã‚·ãƒ¼å®Ÿè£…
```sql
-- âœ… ãã‚ç´°ã‹ã„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
-- åŸºæœ¬çš„ãªèª­ã¿å–ã‚Šãƒãƒªã‚·ãƒ¼
CREATE POLICY "public_read_active_locations" ON locations
FOR SELECT
USING (is_active = TRUE AND visibility = 'public');

-- èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆæ¨©é™
CREATE POLICY "authenticated_create_locations" ON locations
FOR INSERT
WITH CHECK (
  auth.uid() IS NOT NULL 
  AND auth.uid() = created_by
);

-- æ‰€æœ‰è€…ã®ã¿æ›´æ–°å¯èƒ½
CREATE POLICY "owner_update_locations" ON locations
FOR UPDATE
USING (auth.uid() = created_by)
WITH CHECK (auth.uid() = created_by);

-- ç®¡ç†è€…æ¨©é™ã§ã®å‰Šé™¤
CREATE POLICY "admin_delete_locations" ON locations
FOR DELETE
USING (
  EXISTS (
    SELECT 1 FROM user_roles
    WHERE user_id = auth.uid()
    AND role = 'admin'
    AND is_active = TRUE
  )
);
```

### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æœ€é©åŒ–
```sql
-- âœ… åŠ¹ç‡çš„ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
-- å¤‰æ›´é€šçŸ¥ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
CREATE OR REPLACE FUNCTION notify_location_changes()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  -- æœ€å°é™ã®æƒ…å ±ã®ã¿ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
  PERFORM pg_notify(
    'location_updates',
    json_build_object(
      'id', NEW.id,
      'action', TG_OP,
      'category', NEW.category,
      'bounds', json_build_object(
        'lat', NEW.latitude,
        'lng', NEW.longitude
      )
    )::text
  );
  RETURN NEW;
END;
$$;

CREATE TRIGGER trigger_location_updates
AFTER INSERT OR UPDATE OR DELETE ON locations
FOR EACH ROW
EXECUTE FUNCTION notify_location_changes();
```

## ğŸ“ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### DBè¨­è¨ˆææ¡ˆ
```markdown
## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ: [æ©Ÿèƒ½å]

### è¨­è¨ˆæ¦‚è¦
[è¨­è¨ˆã®ç›®çš„ã¨æ¦‚è¦]

### ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 
```sql
-- ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE [table_name] (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  -- ã‚«ãƒ©ãƒ å®šç¾©
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE [related_table] (
  -- ...
);
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å | ã‚«ãƒ©ãƒ  | ç¨®é¡ | ç”¨é€” |
|---------------|--------|------|------|
| idx_xxx | (col1, col2) | BTREE | æ¤œç´¢æœ€é©åŒ– |

### RLSè¨­è¨ˆ
| ãƒãƒªã‚·ãƒ¼ | æ“ä½œ | æ¡ä»¶ | èª¬æ˜ |
|---------|------|------|------|
| policy_1 | SELECT | ... | ... |

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦‹ç©ã‚‚ã‚Š
- æƒ³å®šãƒ‡ãƒ¼ã‚¿é‡: XXä¸‡ä»¶
- ä¸»è¦ã‚¯ã‚¨ãƒªå¿œç­”: <XXms
- åŒæ™‚æ¥ç¶šæ•°: YY
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»
```markdown
## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»: [å¤‰æ›´å†…å®¹]

### å¤‰æ›´æ¦‚è¦
- å½±éŸ¿ãƒ†ãƒ¼ãƒ–ãƒ«: [ãƒ†ãƒ¼ãƒ–ãƒ«ãƒªã‚¹ãƒˆ]
- å½±éŸ¿æ©Ÿèƒ½: [æ©Ÿèƒ½ãƒªã‚¹ãƒˆ]
- ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ : ãªã—/Xmåˆ†

### å®Ÿè¡Œæ‰‹é †
1. **äº‹å‰æº–å‚™**
   - [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
   - [ ] å½±éŸ¿ç¯„å›²ã®é€šçŸ¥

2. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**
   ```sql
   -- Forward migration
   BEGIN;
   -- DDL/DML statements
   COMMIT;
   ```

3. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †**
   ```sql
   -- Rollback migration
   BEGIN;
   -- Revert statements
   COMMIT;
   ```

### ãƒªã‚¹ã‚¯ã¨å¯¾ç­–
| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|--------|------|
| [ãƒªã‚¹ã‚¯1] | High/Medium/Low | [å¯¾ç­–] |
```

## ğŸ¯ å“è³ªåŸºæº–

### è¨­è¨ˆå“è³ª
- [ ] ç¬¬3æ­£è¦å½¢ä»¥ä¸Šï¼ˆå¿…è¦ã«å¿œã˜ã¦éæ­£è¦åŒ–ï¼‰
- [ ] é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿å‹é¸æŠ
- [ ] NULLåˆ¶ç´„ã®é©åˆ‡ãªè¨­å®š
- [ ] å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®æ•´åˆæ€§
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã®å¦¥å½“æ€§

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å“è³ª
- [ ] ä¸»è¦ã‚¯ã‚¨ãƒªå®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª
- [ ] N+1å•é¡Œã®å›é¿
- [ ] é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š
- [ ] ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æˆ¦ç•¥ï¼ˆå¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ï¼‰
- [ ] VACUUM/ANALYZEæˆ¦ç•¥

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å“è³ª
- [ ] RLSãƒãƒªã‚·ãƒ¼ã®ç¶²ç¾…æ€§
- [ ] æœ€å°æ¨©é™ã®åŸå‰‡
- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
- [ ] æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–
- [ ] ç›£æŸ»ãƒ­ã‚°ã®å®Ÿè£…

## ğŸ¤– AIæ´»ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### Claude Code AIä½¿ç”¨ä¾‹
```
ç§ã¯Supabase DBã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€[æ©Ÿèƒ½å]ã®DBè¨­è¨ˆã‚’è¡Œã„ã¾ã™ã€‚

è¦ä»¶:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ï¼ˆRLSï¼‰
- é«˜é€Ÿãªåœ°ç†ç©ºé–“æ¤œç´¢
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é€šçŸ¥
- æœˆé–“100ä¸‡ã‚¯ã‚¨ãƒªæƒ³å®š

ä»¥ä¸‹ã®è¦³ç‚¹ã§è¨­è¨ˆã—ã¦ãã ã•ã„:
1. ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
3. RLSãƒãƒªã‚·ãƒ¼
4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
5. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»

æ—¢å­˜ã®supabase/ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã„ã€
PostgreSQLã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚
```

### MCPæ´»ç”¨
- **Supabase MCP**: ã‚¹ã‚­ãƒ¼ãƒç®¡ç†ãƒ»ãƒ‡ãƒ¼ã‚¿æ“ä½œ
- **GitHub MCP**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
- **Linear MCP**: DBå¤‰æ›´ã‚¿ã‚¹ã‚¯ç®¡ç†

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
```sql
-- ã‚¯ã‚¨ãƒªå®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª
EXPLAIN (ANALYZE, BUFFERS) 
SELECT * FROM your_complex_query;

-- ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã®ç‰¹å®š
SELECT 
  query,
  calls,
  mean_exec_time,
  total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨çŠ¶æ³
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan;
```

### RLSãƒ‡ãƒãƒƒã‚°
```sql
-- RLSãƒãƒªã‚·ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claim.sub = 'user-uuid';

-- ã‚¯ã‚¨ãƒªå®Ÿè¡Œã—ã¦ãƒãƒªã‚·ãƒ¼å‹•ä½œç¢ºèª
SELECT * FROM protected_table;

-- å…ƒã®ãƒ­ãƒ¼ãƒ«ã«æˆ»ã™
RESET ROLE;
```

---

**é‡è¦**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯åŸºç›¤ã§ã™ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ä¿å®ˆæ€§ã®ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã—ã€å°†æ¥ã®æ‹¡å¼µã‚’è¦‹æ®ãˆãŸè¨­è¨ˆã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚